#!/usr/bin/python

# Correa, C.A., Marulanda, G., Garces, A. Optimal Microgrid Management in the
# Colombian Energy Market with Demand Response and Energy Storage
# Microgrid simulation
import datetime

from helperFunctions import *

# Date for energy price, load power and photovoltaic power data
loadDate = datetime.date(2017,6,6)
priceDate = datetime.date(2019,6,6)
# Selects the type of energy price computation
# The options are "market", "creg" and "dynamic"
energyPriceType = "creg"

# Loads supplied and consumed power data from csv file:
# loadPower: power consumed by the loads
# pvPower: power generated by the photovoltaic system
# averageNetLoadPower: average net load Power
# averageYearLoadPower: average year load power
loadPower, pvPower, averageNetLoadPower, averageYearLoadPower = readLoadPVData(loadDate,'59')

# Computes the energy price using different approaches
if energyPriceType == "market":
    # Loads market price data from file precioBolsa.csv:
    energyCost = readMarketPrice(priceDate)
elif energyPriceType == "creg":
    # Computes the energy price using the approach described in CREG 015-2018
    energyCost = computeCregPrice()
elif energyPriceType == "dynamic":
    # Computes the energy price using the dynamic energy approach
    energyCost = computeDynamicPrice(priceDate, averageNetLoadPower, averageYearLoadPower)

# Solves the optimizacion problem
[optimSolFound, gridPower_res, batteryChargePower_res, batteryDischargePower_res, batteryStoredEnergy_res, totalCost] = computeOptimalSolution(loadPower, pvPower, energyCost)
if optimSolFound:
    prepareFigure(priceDate, loadDate, totalCost, energyPriceType, energyCost, gridPower_res, pvPower, loadPower, batteryChargePower_res, batteryDischargePower_res, batteryStoredEnergy_res)
    print("Optimization finished!")

